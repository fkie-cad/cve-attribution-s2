from enum import Enum

from db.models.cvss import common

from mongoengine import EmbeddedDocument, FloatField, EnumField, StringField, EmbeddedDocumentField


class Version(Enum):
    V30 = '3.0'
    V31 = '3.1'


class AttackVector(Enum):
    NETWORK = 'NETWORK'
    ADJACENT_NETWORK = 'ADJACENT_NETWORK'
    LOCAL = 'LOCAL'
    PHYSICAL = 'PHYSICAL'


class ModifiedAttackVector(Enum):
    NETWORK = 'NETWORK'
    ADJACENT_NETWORK = 'ADJACENT_NETWORK'
    LOCAL = 'LOCAL'
    PHYSICAL = 'PHYSICAL'
    NOT_DEFINED = 'NOT_DEFINED'


class AttackComplexity(Enum):
    HIGH = 'HIGH'
    LOW = 'LOW'


class ModifiedAttackComplexity(Enum):
    HIGH = 'HIGH'
    LOW = 'LOW'
    NOT_DEFINED = 'NOT_DEFINED'


class PrivilegesRequired(Enum):
    HIGH = 'HIGH'
    LOW = 'LOW'
    NONE = 'NONE'


class ModifiedPrivilegesRequired(Enum):
    HIGH = 'HIGH'
    LOW = 'LOW'
    NONE = 'NONE'
    NOT_DEFINED = 'NOT_DEFINED'


class UserInteraction(Enum):
    NONE = 'NONE'
    REQUIRED = 'REQUIRED'


class ModifiedUserInteraction(Enum):
    NONE = 'NONE'
    REQUIRED = 'REQUIRED'
    NOT_DEFINED = 'NOT_DEFINED'


class Scope(Enum):
    UNCHANGED = 'UNCHANGED'
    CHANGED = 'CHANGED'


class ModifiedScope(Enum):
    UNCHANGED = 'UNCHANGED'
    CHANGED = 'CHANGED'
    NOT_DEFINED = 'NOT_DEFINED'


class CIA(Enum):
    NONE = 'NONE'
    LOW = 'LOW'
    HIGH = 'HIGH'


class ModifiedCIA(Enum):
    NONE = 'NONE'
    LOW = 'LOW'
    HIGH = 'HIGH'
    NOT_DEFINED = 'NOT_DEFINED'


class CIARequirement(Enum):
    NONE = 'NONE'
    LOW = 'LOW'
    HIGH = 'HIGH'
    NOT_DEFINED = 'NOT_DEFINED'


class Severity(Enum):
    NONE = 'NONE'
    LOW = 'LOW'
    MEDIUM = 'MEDIUM'
    HIGH = 'HIGH'
    CRITICAL = 'CRITICAL'


class ExploitCodeMaturity(Enum):
    UNPROVEN = 'UNPROVEN'
    PROOF_OF_CONCEPT = 'PROOF_OF_CONCEPT'
    FUNCTIONAL = 'FUNCTIONAL'
    HIGH = 'HIGH'
    NOT_DEFINED = 'NOT_DEFINED'


class Confidence(Enum):
    UNKNOWN = 'UNKNOWN'
    REASONABLE = 'REASONABLE'
    CONFIRMED = 'CONFIRMED'
    NOT_DEFINED = 'NOT_DEFINED'


class Metric(EmbeddedDocument):
    # https://csrc.nist.gov/schema/nvd/feed/1.1/cvss-v3.x.json
    version = EnumField(Version, required=True)
    vectorString = StringField(regex=r'^CVSS:3.[01]/((AV:[NALP]|AC:[LH]|PR:[UNLH]|UI:[NR]|S:[UC]|[CIA]:[NLH]|E:['
                                     r'XUPFH]|RL:[XOTWU]|RC:[XURC]|[CIA]R:[XLMH]|MAV:[XNALP]|MAC:[XLH]|MPR:['
                                     r'XUNLH]|MUI:[XNR]|MS:[XUC]|M[CIA]:[XNLH])/)*(AV:[NALP]|AC:[LH]|PR:[UNLH]|UI:['
                                     r'NR]|S:[UC]|[CIA]:[NLH]|E:[XUPFH]|RL:[XOTWU]|RC:[XURC]|[CIA]R:[XLMH]|MAV:['
                                     r'XNALP]|MAC:[XLH]|MPR:[XUNLH]|MUI:[XNR]|MS:[XUC]|M[CIA]:[XNLH])$', required=True)
    attackVector = EnumField(AttackVector)
    attackComplexity = EnumField(AttackComplexity)
    privilegesRequired = EnumField(PrivilegesRequired)
    userInteraction = EnumField(UserInteraction)
    scope = EnumField(Scope)
    confidentialityImpact = EnumField(CIA)
    integrityImpact = EnumField(CIA)
    availabilityImpact = EnumField(CIA)
    baseScore = FloatField(min_value=0.0, max_value=10.0, required=True)
    baseSeverity = EnumField(Severity, required=True)
    exploitCodeMaturity = EnumField(ExploitCodeMaturity)
    remediationLevel = EnumField(common.RemediationLevel)
    reportConfidence = EnumField(Confidence)
    temporalScore = FloatField(min_value=0.0, max_value=10.0)
    temporalSeverity = EnumField(Severity)
    confidentialityRequirement = EnumField(CIARequirement)
    integrityRequirement = EnumField(CIARequirement)
    availabilityRequirement = EnumField(CIARequirement)
    modifiedAttackVector = EnumField(ModifiedAttackVector)
    modifiedAttackComplexity = EnumField(ModifiedAttackComplexity)
    modifiedPrivilegesRequired = EnumField(ModifiedPrivilegesRequired)
    modifiedUserInteraction = EnumField(ModifiedUserInteraction)
    modifiedScope = EnumField(ModifiedScope)
    modifiedConfidentialityImpact = EnumField(ModifiedCIA)
    modifiedIntegrityImpact = EnumField(ModifiedCIA)
    modifiedAvailabilityImpact = EnumField(ModifiedCIA)
    environmentalScore = FloatField(min_value=0.0, max_value=10.0)
    environmentalSeverity = EnumField(Severity)


class BaseMetric(EmbeddedDocument):
    cvssV3 = EmbeddedDocumentField(Metric)
    exploitabilityScore = FloatField(min_value=0.0, max_value=10.0)
    impactScore = FloatField(min_value=0.0, max_value=10.0)
