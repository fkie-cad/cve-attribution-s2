# cve-attribution-s2

Stage two of our proposed static bug attribution pipeline for linux kernel CVEs.

## Methodology Description

This script matches known CVEs to the Linux Kernel Version of a firmware image that has been analyzed by FACT.
Because not all architectures and kernel build configurations are affected by a CVE, we apply the following
methodology to reduce false-positives:

1. Fetch firmwares that have been analyzed with the `kernel_config` FACT plugin
2. Extract the firmware inline kernel config, kernel version, and architecture
3. Download the kernel sources from the [kernel.org](https://kernel.org) archives
4. Install the kernel config and the the architecture
5. Run a make dry-run build by invoking `make ARCH=xxx -Bndi {vmlinux,modules}` 
6. From the resulting build log, extract all source files with the extensions `[chS]`. These files are actually compiled into the firmware kernel
7. Fetch all known linux kernel CVEs for the version in question
8. A large portion of kernel CVEs mention the affected source files in the issue description, we extract those file paths and match them against our build-log-consolidated sources.
9. If there's a match, the firmware is affected by this CVE. If there is no files referenced, we can not categorically filter them out. Fallback to naive version matching

## Install

1. Python Dependencies `pip3 install -r requirements.txt`
2. Install and run [FACT](https://github.com/fkie-cad/FACT_core)
3. *Analyze some firmware with the `kernel_config` plugin enabled*
4. Install and run the auto-updating [cve_database](https://github.com/fkie-cad/cve-attribution-s2/blob/main/nvd-database)

## Synopsis

```bash
$ python3 pcve.py --help
usage: pcve.py [-h] [--fact FACT] [--cve CVE] [--output_applicable OUTPUT_APPLICABLE] [--output_relative_applicable OUTPUT_RELATIVE_APPLICABLE]
               [--output_not_applicable OUTPUT_NOT_APPLICABLE] [--output_unknown OUTPUT_UNKNOWN] [--output_version OUTPUT_VERSION]

Improved CVE Matching to Kernel/Architecture/KConfig-Combinations

options:
  -h, --help            show this help message and exit
  --fact FACT           FACT endpoint base url
  --cve CVE             CVE-DB connection url
  --output_applicable OUTPUT_APPLICABLE
                        json output applicable file
  --output_relative_applicable OUTPUT_RELATIVE_APPLICABLE
                        json output relative applicable file
  --output_not_applicable OUTPUT_NOT_APPLICABLE
                        json output not applicable file
  --output_unknown OUTPUT_UNKNOWN
                        json output unknown applicability file
  --output_version OUTPUT_VERSION
                        json output naive version based applicable file
```

## Output

Output is split into multiple fiÄºes for our case study! See the synopsis above....

... also, it can be used to create some great statistics. Example content:

```json
{
  // FACT firmware id
  "fb721979b235c9da9a9b8e505767ce04410b8c7f5035a73ac2c4cc0b9cada3bd_63558893": [
    // {...},
    {
      "cve": {
        "data_type": "CVE",
        "data_format": "MITRE",
        "data_version": "4.0",
        "CVE_data_meta": {
          "ID": "CVE-2021-29650",
          "ASSIGNER": "cve@mitre.org"
        },
        "problemtype": {
          "problemtype_data": [
            {
              "description": [
                {
                  "lang": "en",
                  "value": "NVD-CWE-noinfo"
                }
              ]
            }
          ]
        },
        "references": {
          "reference_data": [
            {
              "url": "https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=175e476b8cdf2a4de7432583b49c871345e4f8a1",
              "name": "https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=175e476b8cdf2a4de7432583b49c871345e4f8a1",
              "refsource": "MISC",
              "tags": [
                "Mailing List",
                "Patch",
                "Vendor Advisory"
              ]
            },
            {
              "url": "https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.11.11",
              "name": "https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.11.11",
              "refsource": "MISC",
              "tags": [
                "Mailing List",
                "Patch",
                "Vendor Advisory"
              ]
            },
            {
              "url": "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/WKRNELXLVFDY6Y5XDMWLIH3VKIMQXLLR/",
              "name": "FEDORA-2021-41fb54ae9f",
              "refsource": "FEDORA",
              "tags": [
                "Third Party Advisory"
              ]
            },
            {
              "url": "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/RZGMUP6QEHJJEKPMLKOSPWYMW7PXFC2M/",
              "name": "FEDORA-2021-6b0f287b8b",
              "refsource": "FEDORA",
              "tags": [
                "Third Party Advisory"
              ]
            },
            {
              "url": "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/VTADK5ELGTATGW2RK3K5MBJ2WGYCPZCM/",
              "name": "FEDORA-2021-2306e89112",
              "refsource": "FEDORA",
              "tags": [
                "Third Party Advisory"
              ]
            }
          ]
        },
        "description": {
          "description_data": [
            {
              "lang": "en",
              "value": "An issue was discovered in the Linux kernel before 5.11.11. The netfilter subsystem allows attackers to cause a denial of service (panic) because net/netfilter/x_tables.c and include/linux/netfilter/x_tables.h lack a full memory barrier upon the assignment of a new table value, aka CID-175e476b8cdf."
            }
          ]
        }
      },
      "configurations": {
        "CVE_data_version": "4.0",
        "nodes": [
          {
            "operator": "OR",
            "children": [],
            "cpe_match": [
              {
                "vulnerable": true,
                "cpe23Uri": "cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*",
                "versionEndExcluding": "5.11.11",
                "cpe_name": []
              }
            ]
          },
          {
            "operator": "OR",
            "children": [],
            "cpe_match": [
              {
                "vulnerable": true,
                "cpe23Uri": "cpe:2.3:o:fedoraproject:fedora:32:*:*:*:*:*:*:*",
                "cpe_name": []
              },
              {
                "vulnerable": true,
                "cpe23Uri": "cpe:2.3:o:fedoraproject:fedora:33:*:*:*:*:*:*:*",
                "cpe_name": []
              },
              {
                "vulnerable": true,
                "cpe23Uri": "cpe:2.3:o:fedoraproject:fedora:34:*:*:*:*:*:*:*",
                "cpe_name": []
              }
            ]
          }
        ],
        "cpe_match": []
      },
      "impact": {
        "baseMetricV3": {
          "cvssV3": {
            "version": "3.1",
            "vectorString": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
            "attackVector": "LOCAL",
            "attackComplexity": "LOW",
            "privilegesRequired": "LOW",
            "userInteraction": "NONE",
            "scope": "UNCHANGED",
            "confidentialityImpact": "NONE",
            "integrityImpact": "NONE",
            "availabilityImpact": "HIGH",
            "baseScore": 5.5,
            "baseSeverity": "MEDIUM"
          },
          "exploitabilityScore": 1.8,
          "impactScore": 3.6
        },
        "baseMetricV2": {
          "cvssV2": {
            "version": "2.0",
            "vectorString": "AV:L/AC:L/Au:N/C:N/I:N/A:C",
            "accessVector": "LOCAL",
            "accessComplexity": "LOW",
            "authentication": "NONE",
            "confidentialityImpact": "NONE",
            "integrityImpact": "NONE",
            "availabilityImpact": "COMPLETE",
            "baseScore": 4.9
          },
          "severity": "MEDIUM",
          "exploitabilityScore": 3.9,
          "impactScore": 6.9,
          "acInsufInfo": false,
          "obtainAllPrivilege": false,
          "obtainUserPrivilege": false,
          "obtainOtherPrivilege": false,
          "userInteractionRequired": false
        }
      },
      "publishedDate": "2021-03-30T21:15Z",
      "lastModifiedDate": "2021-04-05T20:08Z"
    }
    // {...},
  ],
  // next FACT firmware ID
  '...' : [ /* ... */ ]
}
```
